apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: jenkins
  labels:
    app: jenkins
    component: controller
  annotations:
    description: "Jenkins Controller Deployment"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jenkins
      component: controller
  # Recreate strategy required for RWO persistent volume
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: jenkins
        component: controller
      annotations:
        # Trigger rollout on config change
        checksum/config: "{{ include (print $.Template.BasePath /configmap.yaml) . | sha256sum }}"
    spec:
      serviceAccountName: jenkins

      # Termination grace period
      terminationGracePeriodSeconds: 120

      # Pod Security Context
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      # Init container to set permissions on jenkins home
      initContainers:
        - name: init-permissions
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /var/jenkins_home
              chmod -R 755 /var/jenkins_home
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
          securityContext:
            runAsUser: 0
            allowPrivilegeEscalation: false
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "100m"
              memory: "128Mi"

      containers:
        - name: jenkins
          image: jenkins/jenkins:lts-jdk17
          imagePullPolicy: IfNotPresent

          # Container Security Context
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: jnlp
              containerPort: 50000
              protocol: TCP

          # Environment variables
          env:
            - name: JAVA_OPTS
              value: >-
                -Xmx2g
                -Xms512m
                -XX:+UseG1GC
                -XX:+UseStringDeduplication
                -Djenkins.install.runSetupWizard=false
                -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=false
                -Djava.awt.headless=true
            - name: JENKINS_OPTS
              value: "--httpPort=8080"
            - name: CASC_JENKINS_CONFIG
              value: /var/jenkins_config/jenkins.yaml
            - name: JENKINS_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jenkins-admin-secret
                  key: jenkins-admin-password
            # Kubernetes plugin configuration
            - name: KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          # Resource limits and requests
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"

          # Volume mounts
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
            - name: jenkins-config
              mountPath: /var/jenkins_config
              readOnly: true
            - name: tmp
              mountPath: /tmp

          # Startup probe - allows time for initial startup
          startupProbe:
            httpGet:
              path: /login
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
            successThreshold: 1

          # Liveness probe - restarts if unhealthy
          livenessProbe:
            httpGet:
              path: /login
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
            successThreshold: 1

          # Readiness probe - removes from service if not ready
          readinessProbe:
            httpGet:
              path: /login
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1

      # Volumes
      volumes:
        - name: jenkins-home
          persistentVolumeClaim:
            claimName: jenkins-pvc
        - name: jenkins-config
          configMap:
            name: jenkins-config
        - name: tmp
          emptyDir: {}

      # Node affinity (optional - uncomment if needed)
      # affinity:
      #   nodeAffinity:
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #       nodeSelectorTerms:
      #         - matchExpressions:
      #             - key: node-role.kubernetes.io/ci
      #               operator: Exists

      # Tolerations (optional - uncomment if using dedicated nodes)
      # tolerations:
      #   - key: "dedicated"
      #     operator: "Equal"
      #     value: "ci"
      #     effect: "NoSchedule"
